# -----------------------------------------------------------------------------
# Wisecow CI/CD Pipeline - v5 (K3s via k3d)
# Author   : Somnath Damale (i-damale)
# Purpose  : Build & push Docker image, then deploy to a temporary K3s cluster
#            inside GitHub Actions with TLS + HTTPS check.
#
# History:
#   v1 - Simple Docker build + push to Docker Hub.
#   v2 - Added KinD cluster + nginx ingress, basic HTTPS.
#   v3 - Tweaked ingress + timeouts, but KinD ingress stayed flaky.
#   v4 - Added explicit KinD config + host port mappings, still hit
#        intermittent ingress controller "timeout waiting for condition".
#   v5 - Previous build with MiniKube and KinD did not work hence Switched to K3s (via k3d) for a lighter, more stable cluster with
#        Traefik ingress built-in. Removed manual nginx ingress install.
# -----------------------------------------------------------------------------

name: CI/CD Pipeline (Build + Deploy, K3s v5)

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/wisecow

jobs:
  # ---------------------------------------------------------------------------
  # JOB 1: Build image and push to Docker Hub
  # ---------------------------------------------------------------------------
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build \
            -t $DOCKER_IMAGE:latest \
            -t $DOCKER_IMAGE:v1 \
            .

      - name: Push Docker image (latest + v1)
        run: |
          docker push $DOCKER_IMAGE:latest
          docker push $DOCKER_IMAGE:v1

  # ---------------------------------------------------------------------------
  # JOB 2: Deploy to ephemeral K3s cluster (via k3d) + HTTPS test
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to K3s (k3d) + TLS check
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Corrected port mapping block (NO quotes)
      - name: Create K3d Cluster
        uses: nolar/setup-k3d-k3s@v1
        with:
          version: v1.27
          github-token: ${{ secrets.GITHUB_TOKEN }}
          k3d-tag: latest
          k3d-args: >
            --port 80:80@loadbalancer
            --port 443:443@loadbalancer

      - name: Show cluster info
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods -A

      - name: Apply Deployment manifest
        run: kubectl apply -f deployment.yaml

      - name: Apply Service manifest
        run: kubectl apply -f service.yaml

      - name: Generate self-signed TLS certificate
        run: |
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout tls.key \
            -out tls.crt \
            -subj "/CN=wisecow.local/O=Wisecow"

      - name: Create/Update TLS Secret in cluster
        run: |
          kubectl create secret tls wisecow-tls \
            --cert=tls.crt \
            --key=tls.key \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Ingress manifest
        run: kubectl apply -f ingress.yaml

      - name: Wait for wisecow rollout
        run: kubectl rollout status deployment/wisecow-deployment --timeout=90s

      - name: Add hosts entry for wisecow.local
        run: echo "127.0.0.1 wisecow.local" | sudo tee -a /etc/hosts

      - name: Test HTTPS endpoint via Ingress
        run: |
          echo "Waiting for HTTPS endpoint at https://wisecow.local ..."
          for i in {1..10}; do
            echo "Attempt $i ..."
            if curl -k --max-time 5 https://wisecow.local >/dev/null 2>&1; then
              echo "HTTPS check succeeded on attempt $i"
              exit 0
            fi
            sleep 5
          done
          echo "HTTPS endpoint did not become ready in time"
          kubectl get pods -A
          kubectl get ingress
          exit 1
